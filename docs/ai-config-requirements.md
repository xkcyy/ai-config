# AI 编程伴侣配置同步需求

## 1. 背景与目标
- 统一远程仓库：`http://gitee.com/xkcyy/ai-config.git`，独立于本地任意工程的 Git 仓库。
- 构建一键命令，将远程配置同步到当前工程目录，使 Claude、Code Cursor 等 AI IDE 即刻共享 commands、skills、prompts 等能力。
- 解决手工复制慢、易出错的问题，为工程师提供稳定的“AI 编程伴侣”基础设施。

## 2. 范围
- **包含**：远程仓库读取、`.cursor`/`.claude` 目录同步、基础校验、备份、差异提示、命令日志。
- **不包含**：远程权限管理、CI/CD 集成、IDE 启动脚本、GUI、其他 IDE 目录（如 `.vscode`）。

## 3. 用户与典型场景
- 面向使用 Git 和命令行的开发者，常在多 IDE 之间切换。
- 典型场景：在任意项目根目录执行 `ai-config sync`，即刻获得最新配置；需要可选参数指定 ref、输出差异或回滚。

## 4. 功能需求
### 4.1 同步命令
- 默认命令 `ai-config sync`：拉取固定仓库最新配置，写入当前目录。
- 支持参数：`--ref` 指定分支/标签/commit；`--repo` 覆盖默认仓库；`--target <path>` 指定写入目录。

### 4.2 目录与特性覆盖
- `.cursor`、`.claude` 及其子目录（commands、skills、prompts、workflows、toolchains 等）全部镜像同步。
- 不存在的目录自动创建；已删除的远程文件本地同步删除，保持完全一致。

### 4.3 差异与覆盖策略（简化）
- 同步前检测本地是否存在未提交改动，若有则提示并中止，除非传入 `--force`。
- 输出简洁差异列表（新增/修改/删除文件），帮助用户快速确认。

### 4.4 干运行与日志（简化）
- `--dry-run`：仅展示计划操作和差异，不写入磁盘。
- `--verbose`：打印远程来源、写入路径、耗时；默认仅输出关键节点。

### 4.5 备份与回滚（简化）
- 每次实际写入前，将现有 `.cursor`、`.claude` 复制到 `.ai-config-backup/<timestamp>`。
- 提供 `ai-config rollback <timestamp>` 恢复指定快照，机制保持简单的目录复制即可。

### 4.6 配置校验（简化）
- 同步完成后，对关键 JSON/YAML 文件进行语法校验；失败即回滚并提示文件名与错误原因。

## 5. 非功能需求
- **架构**：遵循 SOLID；同步核心、IDE 适配器、校验器、备份器彼此解耦，便于扩展新 IDE。
- **性能（简化目标）**：首次同步（含克隆）控制在 30 秒内，后续增量同步目标 < 10 秒；采用浅克隆或 `git archive` 降低网络与 I/O。
- **可观测性**：日志可配置级别，失败返回非零退出码。

## 6. 成功判定与扩展
- `ai-config sync` 能在任意工程目录完成全量配置同步，并通过基础校验。
- 具备干运行、差异提示、备份回滚，避免误覆盖。
- 架构允许未来轻松接入其他 IDE 目录或更复杂校验逻辑。
